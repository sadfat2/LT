# 聊天室应用实施计划

## 阶段一：项目初始化与基础设施

- [x] 1. 创建项目目录结构
  - 创建 client/ 前端目录
  - 创建 server/ 后端目录
  - 创建 docker-compose.yml
  - _需求: 基础设施_

- [x] 2. Docker 环境搭建
  - 编写 server/Dockerfile
  - 配置 docker-compose.yml（MySQL、Redis、Node.js）
  - 编写数据库初始化脚本 server/sql/init.sql
  - 验证 docker-compose up 能正常启动
  - _需求: 基础设施_

- [x] 3. 后端项目初始化
  - 初始化 Node.js 项目（package.json）
  - 安装依赖：express, socket.io, mysql2, redis, jsonwebtoken, bcryptjs, multer, cors
  - 创建目录结构（config, controllers, middlewares, models, routes, services, socket, utils）
  - 配置 nodemon 热重载
  - _需求: 基础设施_

- [x] 4. 前端项目初始化
  - 使用 HBuilderX 或 CLI 创建 UniApp 项目（Vue3 + TypeScript）
  - 安装依赖：pinia, @hyoga/uni-socket.io
  - 配置 pages.json、manifest.json
  - 配置全局样式变量（微信绿主题）
  - _需求: 基础设施_

---

## 阶段二：用户认证模块

- [x] 5. 后端 - 用户模型与数据库
  - 创建 User 模型
  - 编写数据库连接配置
  - 创建用户表 SQL
  - _需求: 需求1, 需求2_

- [x] 6. 后端 - 注册接口
  - POST /api/auth/register
  - 账号格式验证（4-20位字母数字）
  - 密码强度验证（6-20位）
  - bcrypt 密码加密
  - 账号唯一性校验
  - _需求: 需求1_

- [x] 7. 后端 - 登录接口
  - POST /api/auth/login
  - 账号密码验证
  - JWT Token 生成
  - _需求: 需求2_

- [x] 8. 后端 - 认证中间件
  - JWT Token 验证中间件
  - 统一错误处理中间件
  - _需求: 需求2_

- [x] 9. 前端 - 登录页面
  - 页面布局（账号、密码输入框，登录按钮）
  - 表单验证
  - 调用登录接口
  - Token 本地存储
  - 登录成功跳转
  - _需求: 需求2_

- [x] 10. 前端 - 注册页面
  - 页面布局（账号、密码、确认密码）
  - 表单验证（格式、密码一致性）
  - 调用注册接口
  - 注册成功自动登录
  - _需求: 需求1_

- [x] 11. 前端 - 请求封装与拦截器
  - 封装 uni.request
  - 请求头自动添加 Token
  - 响应拦截（401 跳转登录）
  - _需求: 需求1, 需求2_

---

## 阶段三：主页框架与个人中心

- [x] 12. 前端 - TabBar 主页框架
  - 配置 pages.json TabBar（消息、通讯录、我的）
  - 创建三个 Tab 页面骨架
  - 底部导航图标
  - _需求: 需求3, 需求8, 需求10_

- [x] 13. 后端 - 用户信息接口
  - GET /api/user/profile 获取当前用户信息
  - PUT /api/user/profile 更新用户信息
  - POST /api/user/avatar 上传头像
  - _需求: 需求10_

- [x] 14. 后端 - 文件上传服务
  - multer 配置
  - 图片类型、大小限制
  - 按日期目录存储
  - 返回访问 URL
  - _需求: 需求5, 需求6, 需求10_

- [x] 15. 前端 - 个人中心页面
  - 用户信息展示（头像、昵称、账号ID、签名）
  - 头像点击上传
  - 昵称、签名编辑弹窗
  - 退出登录功能
  - _需求: 需求10_

- [x] 16. 前端 - Pinia 用户状态管理
  - 用户信息 store
  - 登录状态管理
  - 自动登录逻辑
  - _需求: 需求2, 需求10_

---

## 阶段四：好友与通讯录模块

- [x] 17. 后端 - 好友相关数据模型
  - 创建 friendships 表
  - 创建 friend_requests 表
  - 编写 Friend 模型
  - _需求: 需求8, 需求9_

- [x] 18. 后端 - 好友接口
  - GET /api/friends 获取好友列表（按拼音排序）
  - GET /api/user/search 搜索用户
  - POST /api/friends/request 发送好友申请
  - GET /api/friends/requests 获取申请列表
  - POST /api/friends/accept/:id 同意申请
  - POST /api/friends/reject/:id 拒绝申请
  - _需求: 需求8, 需求9_

- [x] 19. 前端 - 通讯录页面
  - 好友列表展示（按字母分组）
  - 右侧字母索引导航
  - 点击好友跳转聊天
  - 新的朋友入口（红点提醒）
  - _需求: 需求8_

- [x] 20. 前端 - 添加好友页面
  - 搜索框输入账号
  - 搜索结果列表
  - 添加好友按钮
  - _需求: 需求9_

- [x] 21. 前端 - 新的朋友页面
  - 好友申请列表
  - 同意/拒绝按钮
  - 申请状态显示
  - _需求: 需求9_

- [x] 22. 前端 - 好友资料页面
  - 展示好友信息
  - 发消息按钮
  - _需求: 需求8_

---

## 阶段五：实时通信基础

- [x] 23. 后端 - Socket.io 服务搭建
  - Socket.io 服务初始化
  - Socket 认证中间件（Token 验证）
  - Redis 适配器配置（在线状态）
  - _需求: 需求4_

- [x] 24. 后端 - 用户在线状态管理
  - join 事件处理（用户上线）
  - disconnect 事件处理（用户下线）
  - Redis 存储在线状态
  - 通知好友上线/下线
  - _需求: 需求4_

- [x] 25. 前端 - Socket.io 连接封装
  - @hyoga/uni-socket.io 初始化
  - 自动连接/重连逻辑
  - Token 认证
  - 事件监听封装
  - _需求: 需求4_

- [x] 26. 前端 - Socket 状态管理
  - Pinia socket store
  - 连接状态管理
  - 在线好友列表
  - _需求: 需求4_

---

## 阶段六：消息与会话模块

- [x] 27. 后端 - 消息相关数据模型
  - 创建 conversations 表
  - 创建 messages 表
  - 编写 Message、Conversation 模型
  - _需求: 需求3, 需求4_

- [x] 28. 后端 - 会话接口
  - GET /api/conversations 获取会话列表
  - DELETE /api/conversations/:id 删除会话
  - GET /api/messages/:conversationId 获取历史消息（分页）
  - _需求: 需求3, 需求4_

- [x] 29. 后端 - 消息 Socket 事件
  - send_message 发送消息处理
  - 消息存储
  - 会话更新
  - 实时推送给接收方
  - 离线消息处理
  - _需求: 需求4_

- [x] 30. 后端 - 消息已读状态
  - message_read 事件处理
  - 更新消息状态
  - 通知发送方已读
  - _需求: 需求4_

- [x] 31. 前端 - 消息列表页面
  - 会话列表展示
  - 最后消息预览
  - 未读数红点
  - 实时更新
  - 左滑删除
  - _需求: 需求3_

- [x] 32. 前端 - 会话状态管理
  - Pinia conversation store
  - 会话列表缓存
  - 未读数管理
  - _需求: 需求3_

- [x] 33. 前端 - 聊天详情页面基础
  - 页面布局（消息列表、输入区）
  - 消息气泡组件
  - 自己/对方消息样式区分
  - 消息时间显示
  - _需求: 需求4_

- [x] 34. 前端 - 文本消息收发
  - 文本输入框
  - 发送按钮
  - 发送消息（Socket）
  - 接收消息展示
  - 消息状态显示（发送中、已发送、已读）
  - _需求: 需求4_

- [x] 35. 前端 - 历史消息加载
  - 下拉加载更多
  - 分页请求
  - 消息列表滚动定位
  - _需求: 需求4_

---

## 阶段七：图片消息

- [x] 36. 后端 - 图片上传接口
  - POST /api/upload/image
  - 图片压缩处理
  - 生成缩略图
  - _需求: 需求5_

- [x] 37. 前端 - 图片选择组件
  - "+" 按钮扩展面板
  - 相册选择
  - 拍照
  - 图片压缩（前端）
  - _需求: 需求5_

- [x] 38. 前端 - 图片消息发送与展示
  - 上传图片
  - 发送图片消息
  - 图片气泡展示
  - 点击预览大图
  - _需求: 需求5_

---

## 阶段八：语音消息

- [x] 39. 后端 - 语音上传接口
  - POST /api/upload/voice
  - 音频格式处理
  - _需求: 需求6_

- [x] 40. 前端 - 语音录制组件
  - 按住录音按钮
  - 录音状态 UI（波形动画、时长）
  - 上滑取消
  - 录音时长限制（1-60秒）
  - _需求: 需求6_

- [x] 41. 前端 - 语音消息发送与播放
  - 上传语音文件
  - 发送语音消息
  - 语音气泡展示（时长显示）
  - 点击播放
  - 播放动画
  - _需求: 需求6_

---

## 阶段九：消息撤回

- [x] 42. 后端 - 消息撤回
  - revoke_message 事件处理
  - 撤回时间验证（2分钟内）
  - 更新消息状态
  - 通知对方撤回
  - _需求: 需求7_

- [x] 43. 前端 - 消息撤回功能
  - 长按消息弹出菜单
  - 撤回选项（仅自己消息、2分钟内）
  - 撤回消息 Socket 事件
  - 撤回提示展示
  - _需求: 需求7_

---

## 阶段十：好友实时通知

- [x] 44. 后端 - 好友申请实时通知
  - 发送好友申请时推送 Socket 事件
  - 同意好友申请时推送 Socket 事件
  - _需求: 需求9_

- [x] 45. 前端 - 好友通知处理
  - 监听好友申请事件
  - 通讯录红点更新
  - 监听好友同意事件
  - 更新好友列表
  - _需求: 需求9_

---

## 阶段十一：优化与完善

- [ ] 46. 前端 - 消息本地缓存
  - 会话列表缓存
  - 消息历史缓存
  - 缓存更新策略
  - _需求: 性能优化_

- [x] 47. 前端 - 正在输入提示
  - typing 事件发送
  - 对方正在输入展示
  - _需求: 用户体验_

- [x] 48. 全局 - 错误处理与提示
  - 统一错误提示
  - 网络异常处理
  - Socket 断线提示
  - _需求: 用户体验_

- [x] 49. 测试与调试
  - 接口联调测试
  - Socket 事件测试
  - 多端兼容测试（H5）
  - Bug 修复
  - H5 平台语音 API 兼容性处理
  - MySQL LIMIT/OFFSET 预处理语句兼容性修复
  - Vite 代理配置
  - _需求: 质量保证_

---

## 任务统计

| 阶段 | 任务数 | 说明 |
|------|--------|------|
| 阶段一 | 4 | 项目初始化与基础设施 |
| 阶段二 | 7 | 用户认证模块 |
| 阶段三 | 5 | 主页框架与个人中心 |
| 阶段四 | 6 | 好友与通讯录模块 |
| 阶段五 | 4 | 实时通信基础 |
| 阶段六 | 9 | 消息与会话模块 |
| 阶段七 | 3 | 图片消息 |
| 阶段八 | 3 | 语音消息 |
| 阶段九 | 2 | 消息撤回 |
| 阶段十 | 2 | 好友实时通知 |
| 阶段十一 | 4 | 优化与完善 |
| **总计** | **49** | - |

---

## 完成进度

**已完成**: 48/49 任务 (98%)

**未完成任务**:
- [ ] 46. 消息本地缓存（可选优化项）

**测试账号**:
| 账号 | 密码 |
|------|------|
| testuser1 | password123 |
| testuser2 | password123 |
| testuser3 | password123 |

**已修复的问题**:
1. MySQL LIMIT/OFFSET 预处理语句兼容性问题
2. H5 平台 `uni.getRecorderManager` 不支持问题（添加条件编译）
3. H5 平台语音播放使用 HTML5 Audio API 作为回退方案
4. Vite 开发服务器代理配置（/api 和 /socket.io）
5. JSON 字段解析兼容性问题
