# 斗地主游戏需求文档

## 介绍

斗地主游戏是一个独立的 H5 棋牌游戏项目，与现有聊天应用通过 API 集成。用户可以通过聊天应用邀请好友一起玩斗地主，也可以直接进入游戏大厅进行匹配或创建房间。游戏包含虚拟积分系统，支持每日签到、破产补助等功能。

### 设计风格

- **整体风格**：简约现代的棋牌游戏风格
- **主色调**：深绿色 (#1a5f3c) 作为牌桌背景，金色 (#ffd700) 作为强调色
- **辅助色**：深红色 (#c41e3a) 用于地主标识，白色用于文字
- **扑克牌**：经典扑克牌设计，红色（红桃、方块）、黑色（黑桃、梅花）
- **UI 组件**：圆角按钮、半透明面板、渐变背景

---

## 需求

### REQ-001 - 用户注册与登录

**用户故事：** 作为新用户，我希望能够注册账号并登录游戏，以便保存我的游戏数据和积分。

#### 验收标准

1. When 用户访问游戏首页且未登录时，the 系统 shall 显示登录/注册入口
2. When 用户填写账号和密码点击注册时，the 系统 shall 验证账号唯一性并创建用户，初始金币为 10,000
3. When 用户输入正确的账号密码点击登录时，the 系统 shall 验证身份并跳转到游戏大厅
4. When 用户登录失败时，the 系统 shall 显示具体错误信息（账号不存在/密码错误）
5. When 用户已登录时，the 系统 shall 在本地保存登录状态，下次访问自动登录

---

### REQ-002 - 从聊天应用跳转登录

**用户故事：** 作为聊天应用的用户，我希望能够直接从聊天应用跳转到游戏，无需重新登录。

#### 验收标准

1. When 用户从聊天应用点击游戏邀请链接时，the 系统 shall 携带聊天应用的 JWT token 跳转到游戏
2. When 游戏收到聊天 token 时，the 系统 shall 调用聊天服务验证 token 有效性
3. While token 验证通过，when 游戏用户不存在时，the 系统 shall 自动创建关联的游戏账号
4. While token 验证通过，when 游戏用户已存在时，the 系统 shall 直接登录并跳转到目标房间
5. When token 验证失败时，the 系统 shall 提示"登录已过期，请重新从聊天应用进入"

---

### REQ-003 - 积分系统

**用户故事：** 作为玩家，我希望有虚拟积分系统，让游戏更有趣味性和挑战性。

#### 验收标准

1. When 新用户首次登录时，the 系统 shall 赠送 10,000 初始金币
2. When 用户点击每日签到时，the 系统 shall 根据连续签到天数发放奖励（第1天 500，每天递增 100，最高 2000）
3. While 用户已签到，when 再次点击签到时，the 系统 shall 提示"今日已签到"并显示明日奖励
4. While 用户金币少于 1000，when 用户点击"破产补助"时，the 系统 shall 发放 2000 金币（每日限领 3 次）
5. When 游戏结算时，the 系统 shall 根据胜负和倍数计算积分变化并更新余额
6. When 用户金币不足以支付底分时，the 系统 shall 禁止加入该档位的房间

---

### REQ-004 - 游戏大厅

**用户故事：** 作为玩家，我希望在游戏大厅能够查看房间列表、快速匹配或创建房间。

#### 验收标准

1. When 用户进入游戏大厅时，the 系统 shall 显示用户信息（头像、昵称、金币）和功能入口
2. When 用户点击"快速匹配"时，the 系统 shall 根据选择的底分档位自动匹配其他等待的玩家
3. While 匹配中，when 60 秒内未匹配成功时，the 系统 shall 提示"匹配超时"并返回大厅
4. When 用户点击"创建房间"时，the 系统 shall 允许设置底分和可选的房间密码
5. When 用户点击"房间列表"时，the 系统 shall 显示当前所有公开房间（含人数、底分信息）
6. When 用户有未处理的游戏邀请时，the 系统 shall 在大厅显示邀请通知

---

### REQ-005 - 房间系统

**用户故事：** 作为玩家，我希望能够创建或加入房间，与其他玩家一起游戏。

#### 验收标准

1. When 用户创建房间时，the 系统 shall 生成唯一房间 ID 并将用户设为房主
2. When 用户加入公开房间时，the 系统 shall 验证房间人数（< 3）后允许加入
3. While 房间设有密码，when 用户加入时，the 系统 shall 要求输入正确密码
4. When 用户加入房间时，the 系统 shall 实时通知房间内其他玩家
5. When 用户点击"准备"时，the 系统 shall 更新准备状态并通知其他玩家
6. While 3 人全部准备就绪，the 系统 shall 自动开始游戏
7. When 房主点击踢人时，the 系统 shall 将目标玩家移出房间并通知
8. When 用户点击离开房间时，the 系统 shall 将用户移出并通知其他玩家
9. While 房主离开，when 房间内还有其他玩家时，the 系统 shall 将房主转移给下一位玩家
10. While 房间内只剩一人，when 该玩家离开时，the 系统 shall 解散房间

---

### REQ-006 - 发牌与叫地主

**用户故事：** 作为玩家，我希望游戏能够公平发牌，并通过叫地主确定角色。

#### 验收标准

1. When 游戏开始时，the 系统 shall 将 54 张牌随机洗牌后发给 3 位玩家各 17 张，保留 3 张底牌
2. When 发牌完成时，the 系统 shall 随机选择一位玩家先叫地主
3. When 轮到某玩家叫地主时，the 系统 shall 显示 30 秒倒计时和叫分选项（不叫/1分/2分/3分）
4. While 叫分中，when 玩家选择的分数高于当前最高叫分时，the 系统 shall 更新最高叫分并继续
5. While 叫分中，when 玩家选择"不叫"时，the 系统 shall 轮到下一位玩家
6. When 有玩家叫 3 分时，the 系统 shall 立即确定该玩家为地主
7. When 所有玩家轮完一圈后，the 系统 shall 确定叫分最高的玩家为地主
8. While 所有玩家都不叫，the 系统 shall 重新发牌
9. When 地主确定时，the 系统 shall 将 3 张底牌发给地主并公示
10. While 叫分超时，when 玩家未操作时，the 系统 shall 自动选择"不叫"

---

### REQ-007 - 出牌规则

**用户故事：** 作为玩家，我希望游戏能够正确判断牌型并验证出牌合法性。

#### 验收标准

1. When 地主确定后，the 系统 shall 由地主先出牌
2. When 轮到某玩家出牌时，the 系统 shall 显示 30 秒倒计时
3. When 玩家选择手牌并点击"出牌"时，the 系统 shall 验证牌型合法性
4. While 牌型合法且能压过上家，the 系统 shall 接受出牌并通知其他玩家
5. While 牌型不合法或无法压过上家，the 系统 shall 提示"牌型错误"或"压不过"
6. When 玩家点击"不出"时，the 系统 shall 跳过该玩家（首轮必须出牌除外）
7. While 连续两人不出，when 轮回到上一个出牌者时，the 系统 shall 开始新一轮（任意出牌）
8. While 出牌超时，when 玩家未操作时，the 系统 shall 自动选择"不出"（可出时自动出最小的牌）
9. The 系统 shall 支持以下牌型：
   - 单张
   - 对子（两张相同）
   - 三张（三张相同）
   - 三带一（三张 + 任意一张）
   - 三带二（三张 + 一对）
   - 顺子（至少 5 张连续，不含 2 和王）
   - 连对（至少 3 对连续，不含 2 和王）
   - 飞机不带（至少 2 组连续三张）
   - 飞机带单（飞机 + 等量单张）
   - 飞机带对（飞机 + 等量对子）
   - 四带二（四张 + 任意两张单牌）
   - 四带两对（四张 + 两对）
   - 炸弹（四张相同）
   - 王炸（大小王）
10. When 出炸弹或王炸时，the 系统 shall 将当前倍数翻倍

---

### REQ-008 - 游戏结算

**用户故事：** 作为玩家，我希望游戏结束后能看到清晰的结算信息。

#### 验收标准

1. When 某一方出完所有手牌时，the 系统 shall 判定该方获胜并结束游戏
2. When 地主先出完时，the 系统 shall 判定地主胜利
3. When 任一农民先出完时，the 系统 shall 判定农民胜利
4. While 地主获胜且两位农民均未出过牌，the 系统 shall 判定"春天"，倍数翻倍
5. While 农民获胜且地主只出过一手牌，the 系统 shall 判定"反春"，倍数翻倍
6. When 游戏结束时，the 系统 shall 计算积分变化：底分 × 叫分倍数 × 炸弹倍数 × 春天倍数
7. When 游戏结束时，the 系统 shall 显示结算弹窗（胜负、积分变化、各方剩余手牌）
8. When 结算完成时，the 系统 shall 更新玩家金币余额和战绩统计
9. When 玩家点击"再来一局"时，the 系统 shall 返回房间等待界面
10. When 玩家点击"返回大厅"时，the 系统 shall 退出房间返回游戏大厅

---

### REQ-009 - 游戏内社交

**用户故事：** 作为玩家，我希望在游戏中能与其他玩家进行简单互动。

#### 验收标准

1. When 用户点击表情按钮时，the 系统 shall 显示表情选择面板
2. When 用户选择表情时，the 系统 shall 在用户头像旁播放表情动画，并同步给其他玩家
3. When 用户点击快捷消息时，the 系统 shall 显示预设消息列表（如"快点啊""不要走运""厉害"等）
4. When 用户选择快捷消息时，the 系统 shall 在聊天区域显示消息，并同步给其他玩家
5. While 游戏进行中，when 用户发送消息时，the 系统 shall 限制发送频率（每 3 秒最多 1 条）

---

### REQ-010 - 聊天应用集成 - 游戏邀请

**用户故事：** 作为聊天应用用户，我希望能够邀请好友一起玩斗地主。

#### 验收标准

1. When 聊天应用用户点击"邀请玩斗地主"时，the 聊天应用 shall 调用游戏服务创建邀请
2. When 邀请创建成功时，the 聊天应用 shall 在聊天中发送游戏邀请卡片消息
3. When 被邀请人点击邀请卡片时，the 系统 shall 跳转到游戏并自动加入对应房间
4. While 邀请超过 5 分钟，when 被邀请人点击卡片时，the 系统 shall 提示"邀请已过期"
5. While 房间已满或已解散，when 被邀请人点击卡片时，the 系统 shall 提示"房间不存在或已满"

---

### REQ-011 - 聊天应用集成 - 结果同步

**用户故事：** 作为玩家，我希望游戏结果能同步到聊天记录，方便回顾和分享。

#### 验收标准

1. When 游戏结束时，the 游戏服务 shall 调用聊天服务接口发送游戏结果
2. When 聊天服务收到结果时，the 系统 shall 在相关用户的聊天中显示游戏结果卡片
3. The 游戏结果卡片 shall 包含：参与玩家、胜负结果、积分变化、游戏时长

---

### REQ-012 - 断线重连

**用户故事：** 作为玩家，我希望在网络断开后能够重新连接并继续游戏。

#### 验收标准

1. While 游戏进行中，when 玩家网络断开时，the 系统 shall 保留其座位 60 秒
2. While 断线玩家的座位保留中，when 轮到该玩家时，the 系统 shall 自动"不出"（或最小出牌）
3. When 断线玩家在 60 秒内重连时，the 系统 shall 恢复其游戏状态并继续
4. While 断线超过 60 秒，the 系统 shall 判定该玩家逃跑，自动认输并扣除相应积分
5. When 玩家重新进入游戏时，the 系统 shall 检测是否有未完成的游戏并提示"是否回到游戏"

---

### REQ-013 - 个人中心

**用户故事：** 作为玩家，我希望能查看自己的战绩和游戏数据。

#### 验收标准

1. When 用户点击个人中心时，the 系统 shall 显示用户基本信息（头像、昵称、等级）
2. The 系统 shall 显示战绩统计：总场次、胜场、胜率、最高连胜
3. The 系统 shall 显示积分信息：当前金币、累计赢取、累计输掉
4. The 系统 shall 显示签到记录：连续签到天数、今日是否已签到
5. When 用户点击修改昵称时，the 系统 shall 允许修改并保存

---

## 非功能需求

### NFR-001 - 性能要求

1. 页面加载时间 shall 不超过 3 秒（首屏）
2. Socket 消息延迟 shall 不超过 200ms（正常网络环境）
3. 系统 shall 支持至少 1000 个并发游戏房间

### NFR-002 - 安全要求

1. 用户密码 shall 使用 bcrypt 加密存储
2. 服务间通信 shall 使用 API Key 认证
3. JWT token shall 设置合理过期时间（7 天）
4. 游戏逻辑 shall 在服务端执行，防止客户端作弊

### NFR-003 - 兼容性要求

1. 系统 shall 支持 Chrome 80+、Safari 13+、Firefox 75+ 浏览器
2. 系统 shall 支持移动端 H5 访问（响应式布局）
