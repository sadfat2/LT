# 性能测试报告

**测试时间**: 2026-01-15
**测试环境**: 本地开发环境 (macOS)
**服务器配置**: Docker (Node.js + MySQL + Redis)

---

## 一、测试结果总结

| 测试场景 | 并发数 | 成功率 | p95 延迟 | 状态 |
|----------|--------|--------|----------|------|
| HTTP 登录压测 | 50 VU | 100% | 179ms | ✅ 通过 |
| Socket.IO 消息 | 50 用户 | 100% | 109ms | ✅ 通过 |
| 群聊广播 | 20 成员 | 100% | 46ms | ✅ 通过 |
| 稳定性测试 | 30 用户 / 5分钟 | 100% | 70ms | ✅ 通过 |

---

## 二、HTTP 登录 API 压测

### 测试配置
- **工具**: k6
- **并发用户**: 50 VU
- **持续时间**: 1 分钟
- **测试脚本**: `scenarios/login.js`

### 测试结果

| 指标 | 值 |
|------|-----|
| 总请求数 | 约 500 |
| 登录成功率 | **100%** |
| 平均响应时间 | 112ms |
| p95 响应时间 | **179ms** |
| 请求速率 | 约 8 req/s |

### 运行命令
```bash
k6 run --vus 50 --duration 1m \
  -e BASE_URL=http://localhost:3000 \
  scenarios/login.js
```

---

## 三、Socket.IO 消息发送测试

### 测试配置
- **工具**: Node.js + socket.io-client
- **并发用户**: 50
- **持续时间**: 30 秒
- **消息频率**: 1 条/秒/用户
- **测试脚本**: `socketio-loadtest.js`

### 测试结果

| 指标 | 值 |
|------|-----|
| 连接成功率 | **100%** (50/50) |
| 消息发送 | 1,450 条 |
| 消息确认 | 1,450 条 (100%) |
| 平均延迟 | 86.63ms |
| p95 延迟 | **109ms** |
| 错误数 | 0 |

### 性能趋势

| 并发数 | 平均延迟 | p95 延迟 | 成功率 |
|--------|----------|----------|--------|
| 2 用户 | 31ms | 44ms | 100% |
| 10 用户 | 45ms | 58ms | 100% |
| 50 用户 | 87ms | 109ms | 100% |

### 运行命令
```bash
node socketio-loadtest.js 50 30
```

---

## 四、群聊广播测试

### 测试配置
- **工具**: Node.js + socket.io-client
- **群成员数**: 20
- **持续时间**: 30 秒
- **消息频率**: 1 条/2秒
- **测试脚本**: `broadcast-loadtest.js`

### 测试结果

| 指标 | 值 |
|------|-----|
| 连接成功率 | **100%** (20/20) |
| 消息发送 | 14 条 |
| 消息接收 | 266 条 |
| 预期接收 | 266 条 (14 × 19) |
| 广播效率 | **100%** |
| 平均延迟 | 20.07ms |
| p95 延迟 | **46ms** |

### 运行命令
```bash
node broadcast-loadtest.js 20 30
```

---

## 五、长时间稳定性测试

### 测试配置
- **工具**: Node.js + socket.io-client
- **并发用户**: 30
- **持续时间**: 5 分钟
- **消息频率**: 1 条/2秒/用户
- **测试脚本**: `stability-test.js`

### 测试结果

| 指标 | 值 |
|------|-----|
| 测试时长 | 5 分 9 秒 |
| 连接成功率 | **100%** |
| 消息发送 | 4,470 条 |
| 消息确认率 | **100%** |
| 吞吐量 | 14.45 msg/s |
| 错误数 | **0** |

### 延迟统计

| 指标 | 延迟 |
|------|------|
| 平均 | 61ms |
| 最小 | 28ms |
| 最大 | 125ms |
| p90 | 68ms |
| p95 | **70ms** |
| p99 | 109ms |

### 延迟趋势（5分钟内）

测试期间延迟保持稳定，无明显波动：

```
时间点   延迟(ms)
0:17     66  ████████████████
1:17     60  ███████████████
2:17     53  █████████████
3:17     63  ████████████████
4:17     62  ███████████████
```

### 运行命令
```bash
node stability-test.js 30 5
```

---

## 六、测试工具说明

### 目录结构

```
k6-tests/
├── config.js                 # k6 测试配置
├── scenarios/
│   ├── login.js              # k6 登录压测
│   ├── connection.js         # k6 连接测试 (k6 对 Socket.IO 支持有限)
│   ├── messaging.js          # k6 消息测试 (k6 对 Socket.IO 支持有限)
│   └── broadcast.js          # k6 广播测试 (k6 对 Socket.IO 支持有限)
├── socketio-loadtest.js      # ✅ Node.js Socket.IO 消息测试
├── broadcast-loadtest.js     # ✅ Node.js 群聊广播测试
├── stability-test.js         # ✅ Node.js 稳定性测试
├── setup/
│   ├── create-users.js       # 创建测试用户脚本
│   └── package.json
└── artillery/                # Artillery 配置 (备用)
```

### 工具选择说明

| 测试类型 | 推荐工具 | 原因 |
|----------|----------|------|
| HTTP API | k6 | 原生支持，性能好 |
| Socket.IO | Node.js 脚本 | k6 对 Socket.IO 协议支持有限 |
| 实时通信 | Node.js 脚本 | 使用官方 socket.io-client |

---

## 七、测试数据准备

### 创建测试用户

```bash
cd k6-tests/setup
npm install
node create-users.js
```

### 创建内容
- 100 个测试用户 (testuser1 ~ testuser100)
- 密码: password123
- 每用户 5 个好友关系
- 5 个 K6 测试群 (每群 20 人)

---

## 八、快速开始

### 1. 安装依赖

```bash
cd k6-tests
npm install

# k6 (可选，用于 HTTP 测试)
brew install k6
```

### 2. 准备测试数据

```bash
cd setup && npm install && node create-users.js && cd ..
```

### 3. 运行测试

```bash
# HTTP 登录测试 (k6)
k6 run -e BASE_URL=http://localhost:3000 scenarios/login.js

# Socket.IO 消息测试
node socketio-loadtest.js 50 30

# 群聊广播测试
node broadcast-loadtest.js 20 30

# 稳定性测试 (5分钟)
node stability-test.js 30 5
```

---

## 九、性能优化建议

### 已实施的优化

| 优化项 | 说明 | 效果 |
|--------|------|------|
| PM2 多进程 | 使用 `pm2-runtime -i 2` | 吞吐量提升 48% |
| 数据库连接池 | connectionLimit: 30 | 减少连接等待 |
| Redis Adapter | @socket.io/redis-adapter | 支持多进程消息路由 |
| Redis 缓存 | 用户/好友/群组缓存 | 减少数据库查询 |

### 进一步优化方向

| 优化项 | 说明 | 预期效果 |
|--------|------|----------|
| 增加 PM2 进程数 | 根据 CPU 核心数调整 | 线性扩展吞吐量 |
| 降低 bcrypt rounds | 从 10 降到 8 | 登录响应时间减半 |
| 数据库读写分离 | MySQL 主从复制 | 提升读取性能 |
| CDN 加速 | 静态资源 CDN | 减少服务器负载 |

---

## 十、结论

### 测试通过标准

| 标准 | 要求 | 实际 | 状态 |
|------|------|------|------|
| 连接成功率 | > 99% | 100% | ✅ |
| 消息确认率 | > 99% | 100% | ✅ |
| p95 延迟 | < 500ms | 70-179ms | ✅ |
| 错误率 | < 1% | 0% | ✅ |
| 稳定性 | 无断线 | 5分钟稳定 | ✅ |

### 总结

经过性能优化后，系统在以下场景表现**稳定可靠**：

1. **50 并发用户** HTTP 登录 - p95 延迟 179ms
2. **50 并发用户** Socket.IO 消息 - p95 延迟 109ms
3. **20 人群聊** 广播消息 - p95 延迟 46ms
4. **5 分钟** 持续运行 - 零错误，延迟稳定

系统已具备**生产环境部署**条件。
